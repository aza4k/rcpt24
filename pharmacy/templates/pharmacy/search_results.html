{% extends "base.html" %}
{% block title %}Dori topish â€” Recept24.uz{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto px-4 py-10 relative">
  <h1 class="text-2xl font-bold text-center text-emerald-700 mb-8">
    ðŸ’Š Dori topish
  </h1>

  <form method="get" action="." class="flex flex-col sm:flex-row justify-center items-center gap-3 mb-8 relative">
    <div class="relative w-full sm:w-80">
      <input type="text" name="q" placeholder="Dori nomi..." value="{{ request.GET.q }}"
             class="w-full px-4 py-2 border rounded-2xl shadow focus:outline-none focus:ring-2 focus:ring-emerald-500">
      <!-- Live search results -->
      <div id="live-results" class="absolute left-0 right-0 bg-white border rounded-lg mt-1 shadow-lg z-50 hidden"></div>
    </div>

    <input type="text" name="city" placeholder="Manzil boâ€˜yicha" value="{{ request.GET.city }}"
           class="w-full sm:w-60 px-4 py-2 border rounded-2xl shadow focus:outline-none focus:ring-2 focus:ring-emerald-500">

    <input type="number" step="0.01" min="0" name="min_price" placeholder="Min narx"
           value="{{ request.GET.min_price }}"
           class="w-full sm:w-40 px-4 py-2 border rounded-2xl shadow focus:outline-none focus:ring-2 focus:ring-emerald-500">

    <input type="number" step="0.01" min="0" name="max_price" placeholder="Maks narx"
           value="{{ request.GET.max_price }}"
           class="w-full sm:w-40 px-4 py-2 border rounded-2xl shadow focus:outline-none focus:ring-2 focus:ring-emerald-500">

    <label class="inline-flex items-center gap-2 text-sm text-gray-700">
      <input type="checkbox" name="available" value="1" {% if request.GET.available == '1' %}checked{% endif %}>
      Mavjud (omborda)
    </label>
    <button type="submit"
            class="bg-emerald-600 hover:bg-emerald-700 text-white px-6 py-2 rounded-2xl shadow transition">
      Qidirish
    </button>
  </form>

  {% if inventories %}
  <div class="bg-white rounded-2xl shadow p-5 relative z-10">
    <div id="map" class="w-full h-96 rounded-xl mb-6 z-0"></div>

    <div class="grid md:grid-cols-2 gap-5">
      {% for inv in inventories %}
      <div class="border rounded-2xl p-4 shadow-sm hover:shadow-md transition">
        <h3 class="font-semibold text-emerald-700 text-lg mb-1">{{ inv.pharmacy.name }}</h3>
        <p class="text-gray-500 text-sm mb-2">{{ inv.pharmacy.address }}</p>
        <div class="flex justify-between items-center">
          <p class="text-red-600">ðŸ’Š {{ inv.medicine.name }} â€” <b>{{ inv.quantity }}</b> dona</p>
          <p class="text-yellow-600 font-semibold">ðŸ’° {{ inv.price }} soâ€˜m</p>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
  {% else %}
    <p class="text-center text-gray-500 mt-10">Hech qanday natija topilmadi.</p>
  {% endif %}

  {% if page_obj and page_obj.paginator.num_pages > 1 %}
  <div class="mt-6 flex justify-center gap-2">
    {% if page_obj.has_previous %}
      <a class="px-3 py-1 rounded border text-emerald-700" href="?{% if request.GET.q %}q={{ request.GET.q|urlencode }}&{% endif %}{% if request.GET.city %}city={{ request.GET.city|urlencode }}&{% endif %}{% if request.GET.min_price %}min_price={{ request.GET.min_price }}&{% endif %}{% if request.GET.max_price %}max_price={{ request.GET.max_price }}&{% endif %}{% if request.GET.available %}available=1&{% endif %}page={{ page_obj.previous_page_number }}">Oldingi</a>
    {% endif %}
    <span class="px-3 py-1">{{ page_obj.number }} / {{ page_obj.paginator.num_pages }}</span>
    {% if page_obj.has_next %}
      <a class="px-3 py-1 rounded border text-emerald-700" href="?{% if request.GET.q %}q={{ request.GET.q|urlencode }}&{% endif %}{% if request.GET.city %}city={{ request.GET.city|urlencode }}&{% endif %}{% if request.GET.min_price %}min_price={{ request.GET.min_price }}&{% endif %}{% if request.GET.max_price %}max_price={{ request.GET.max_price }}&{% endif %}{% if request.GET.available %}available=1&{% endif %}page={{ page_obj.next_page_number }}">Keyingi</a>
    {% endif %}
  </div>
  {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener("DOMContentLoaded", () => {
  // === Live search ===
  const input = document.querySelector("input[name='q']");
  const dropdown = document.getElementById("live-results");

  input.addEventListener("input", async () => {
    const q = input.value.trim();
    if (q.length < 2) {
      dropdown.classList.add("hidden");
      dropdown.innerHTML = "";
      return;
    }

    try {
      const res = await fetch(`/api/search/?q=${encodeURIComponent(q)}`);
      const data = await res.json();

      if (!data.length) {
        dropdown.innerHTML = `<div class='p-2 text-gray-500'>Natija yoâ€˜q</div>`;
      } else {
        dropdown.innerHTML = data
          .map(
            d => `<div class='p-2 hover:bg-emerald-50 cursor-pointer'
                     onclick="window.location.href='/medicine/${d.slug}/'">
                     <strong>${d.name}</strong>
                     <span class='text-gray-500 text-sm'> â€” ${d.pharmacies_count} dorixona</span>
                   </div>`
          )
          .join("");
      }

      dropdown.classList.remove("hidden");
    } catch (err) {
      console.error(err);
    }
  });

  document.addEventListener("click", e => {
    if (!input.contains(e.target)) dropdown.classList.add("hidden");
  });

  // === Leaflet map ===
  const points = [
    {% for inv in inventories %}
      {% if inv.pharmacy.lat and inv.pharmacy.lng %}
        {name: "{{ inv.pharmacy.name|escapejs }}", lat: {{ inv.pharmacy.lat }}, lng: {{ inv.pharmacy.lng }},
         info: "{{ inv.pharmacy.address|escapejs }}", link: "{% url 'pharmacy:pharmacy_detail' inv.pharmacy.id %}"},
      {% endif %}
    {% endfor %}
  ];

  if (points.length) {
    const map = L.map('map').setView([points[0].lat, points[0].lng], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    points.forEach(p => {
      L.marker([p.lat, p.lng]).addTo(map)
        .bindPopup(`<b><a href="${p.link}" class="text-emerald-700">${p.name}</a></b><br>${p.info}`);
    });
  }
});
</script>
{% endblock %}
